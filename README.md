# Avidyne R9 Data Loader

This project converts CSV files generated by the Avidyne Entegra R9 integrated
flight deck into TSV files that can be loaded into PostgreSQL using a foreign
data wrapper (FDW), in the schema used by the OneMikeAlpha website
(https://github.com/RISCfuture/OneMikeAlpha).

This project is written in pure C for speed efficiency and portability.

## Usage

``` sh
AvidyneR9Loader /path/to/csv_files/C_*.CSV /path/to/csv_files/P_*.CSV
```

The executable expects to passed a glob of related CSV files from the same data
dump (e.g, `C_ENGINE.CSV`, `C_FLIGHT.CSV`, `C_SYSTEM.CSV`). This is so it can
interleave data with the same timestamps. You can pass it files from more than
one data dump, but you must include all three files from each data dump in your
glob(s).

The executable will generate `.tsv` files, one for each table. These TSV files
can be imported into virtual PostgreSQL tables using the `file_fdw` extension:

``` sql
CREATE EXTENSION file_fdw;
CREATE SERVER r9_import FOREIGN DATA WRAPPER file_fdw;

CREATE FOREIGN TABLE telemetry_tsv ([... columns ...]) OPTIONS (filename '/path/to/output/telemetry.tsv', format 'csv', delimiter '\t');
-- repeat for each TSV file in the output directory
```

You can then use the `COPY TABLE` PostgreSQL command to efficiently move the
data into your database.

## Architecture

The executable operates in three stages:

1. The CSV files are parsed into memory structures using `libcsv`.
2. The data from the CSV files are transformed into an aircraft data structure.
3. The aircraft data is written to TSV files.

The data structure that manages overall state and stores all executable data
lives at `context.c`. The `main.c` entry point parses the glob, generates the
`context` object, and tells the context object to do the three steps above.

### Parsing Entegra R9 CSV files

The CSV files are opened and read by the code in `csv/csv.c`. The data in the
CSV files is parsed by the code in the `csv/parser.c` file, which generates data
structures (`csv/csv_record.c`) that store the CSV data.

Each `csv_record` is stored in the `context` struct as part of a linked list. On
top of this linked list is a 62-ary tree that allows efficient logarithmic
access of each CSV record according to its date and time values.

As each new CSV record is parsed, the date and time are combined to form a key
for the record. Any future records (across any of the files being parsed) with
the same date and time are merged into the existing records. This serves to
consolidate data split across different files for the same time, as well as
merging sub-second-resolution data into one-second intervals.

The linked list underlying the tree is then merge-sorted by timestamp for
efficient in-order access.

### Transforming CSV data to aircraft data

The `aircraft_record` struct (and its various sub-structs, all defined at
`aircraft/aircraft_record.c`) stores all the telemetry in a fashion that more
closely approximates the schema used by the PostgreSQL database. This is in
contrast to `csv_record`, which stores the data in a format closely bound to the
Avidyne Entegra R9 export format. The code at `aircraft/transformer.c`
transforms `csv_record`s into `aircraft_record`s. It also interpolates
calculated data from known values, such as calculating speed of sound and Mach
values from atmospheric properties recorded by the Entegra R9.

`aircraft_record`s are stored in a linked list.

### Writing aircraft data to TSV files

The `database/writer.c` code writes `aircraft_record`s out to TSV files with a
schema matching that of the OneMikeAlpha PostgreSQL database.'